<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered ATS Simulation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>
    <!-- mammoth.js for .docx parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <!-- jsPDF and autotable for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .section-fade-in {
            animation: fadeIn 0.8s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .glowing-border {
            border: 2px solid transparent;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .glowing-border:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">AI-Powered ATS Simulation</h1>
            <p class="text-gray-400 mt-2">Compare your resume against a job description with keyword & semantic analysis.</p>
        </header>

        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Inputs -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Inputs</h2>
                
                <!-- Resume Input -->
                <div class="mb-6">
                    <label for="resume-input" class="block text-lg font-medium mb-2">Resume</label>
                    <div class="glowing-border bg-gray-900 rounded-lg">
                        <textarea id="resume-input" rows="12" class="w-full bg-transparent p-3 rounded-lg focus:outline-none resize-y" placeholder="Paste resume text here or upload a file..."></textarea>
                    </div>
                    <div class="mt-3 text-right">
                        <input type="file" id="resume-upload" class="hidden" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event, 'resume-input')">
                        <button onclick="document.getElementById('resume-upload').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Upload Resume</button>
                    </div>
                </div>

                <!-- Job Description Input -->
                <div class="mb-6">
                    <label for="jd-input" class="block text-lg font-medium mb-2">Job Description</label>
                    <div class="glowing-border bg-gray-900 rounded-lg">
                        <textarea id="jd-input" rows="12" class="w-full bg-transparent p-3 rounded-lg focus:outline-none resize-y" placeholder="Paste job description here or upload a file..."></textarea>
                    </div>
                    <div class="mt-3 text-right">
                        <input type="file" id="jd-upload" class="hidden" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event, 'jd-input')">
                        <button onclick="document.getElementById('jd-upload').click()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Upload JD</button>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center justify-between mt-6 flex-wrap gap-4">
                     <div class="flex items-center space-x-4">
                        <span class="text-lg font-medium">Analysis Mode:</span>
                        <div class="flex items-center space-x-3">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="analysis-mode" value="keyword" class="form-radio h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                                <span class="ml-2 text-gray-200">Keyword</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="analysis-mode" value="semantic" class="form-radio h-5 w-5 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-200">Semantic</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex gap-4">
                         <button id="clear-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Clear All</button>
                        <button id="scan-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">Analyze</button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div id="results-container" class="bg-gray-800 p-6 rounded-2xl shadow-lg hidden">
                <!-- Placeholder for results -->
            </div>
            
            <!-- Initial State Message -->
            <div id="initial-state" class="flex items-center justify-center bg-gray-800 p-6 rounded-2xl shadow-lg">
                 <div class="text-center text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <h3 class="text-2xl font-semibold text-white">Analysis Results Will Appear Here</h3>
                    <p class="mt-2">Provide a resume and job description, then click "Analyze".</p>
                </div>
            </div>
             <div id="loading-state" class="hidden flex items-center justify-center bg-gray-800 p-6 rounded-2xl shadow-lg">
                <div class="text-center text-gray-300">
                    <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-xl font-semibold mt-4">Analyzing...</p>
                    <p class="text-gray-400">This may take a moment.</p>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-8 text-gray-500">
            <p>&copy; 2025 ATS Simulation Tool. All processing is done locally in your browser. No data is stored or transmitted.</p>
        </footer>
    </div>

<script>
// --- CORE LOGIC & STATE MANAGEMENT ---

const scanBtn = document.getElementById('scan-btn');
const clearBtn = document.getElementById('clear-btn');
const resultsContainer = document.getElementById('results-container');
const initialState = document.getElementById('initial-state');
const loadingState = document.getElementById('loading-state');
const resumeInput = document.getElementById('resume-input');
const jdInput = document.getElementById('jd-input');

scanBtn.addEventListener('click', () => {
    const resumeText = resumeInput.value;
    const jdText = jdInput.value;
    const mode = document.querySelector('input[name="analysis-mode"]:checked').value;

    if (!resumeText.trim() || !jdText.trim()) {
        alert('Please provide both a resume and a job description.');
        return;
    }

    initialState.classList.add('hidden');
    resultsContainer.classList.add('hidden');
    loadingState.classList.remove('hidden');

    // Simulate async processing
    setTimeout(() => {
        const analysisResult = performAnalysis(resumeText, jdText, mode);
        renderResults(analysisResult);
        loadingState.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }, 1500);
});

clearBtn.addEventListener('click', () => {
    resumeInput.value = '';
    jdInput.value = '';
    document.getElementById('resume-upload').value = '';
    document.getElementById('jd-upload').value = '';
    resultsContainer.innerHTML = '';
    resultsContainer.classList.add('hidden');
    initialState.classList.remove('hidden');
    loadingState.classList.add('hidden');
});


// --- FILE HANDLING ---

async function handleFileUpload(event, targetTextareaId) {
    const file = event.target.files[0];
    if (!file) return;

    const textarea = document.getElementById(targetTextareaId);
    const reader = new FileReader();

    if (file.type === "application/pdf") {
        reader.onload = async (e) => {
            const pdfData = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            let textContent = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                textContent += text.items.map(item => item.str).join(' ') + '\n';
            }
            textarea.value = textContent;
        };
        reader.readAsArrayBuffer(file);
    } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
        reader.onload = (e) => {
            mammoth.extractRawText({ arrayBuffer: e.target.result })
                .then(result => {
                    textarea.value = result.value;
                })
                .catch(err => {
                    console.error("Error parsing .docx file:", err);
                    alert("Could not read the .docx file.");
                    textarea.value = '';
                });
        };
        reader.readAsArrayBuffer(file);
    } else { // Plain text
        reader.onload = (e) => {
            textarea.value = e.target.result;
        };
        reader.readAsText(file);
    }
}


// --- "AI" ANALYSIS SIMULATION ---

function performAnalysis(resumeText, jdText, mode) {
    // This is a simplified simulation of a complex ATS.
    // A real system would use advanced NLP models.

    const skillTaxonomy = {
        // ... (Expanded taxonomy)
        'Cloud Platforms': ['aws', 'azure', 'gcp', 'google cloud', 'amazon web services', 'heroku', 'digitalocean'],
        'Programming Languages': ['python', 'javascript', 'java', 'c#', 'c++', 'ruby', 'go', 'typescript', 'sql', 'php'],
        'Data & Analytics': ['etl', 'data pipeline', 'data warehousing', 'business intelligence', 'machine learning', 'ai', 'tensorflow', 'pytorch', 'scikit-learn', 'pandas', 'numpy', 'databricks', 'snowflake', 'tableau', 'power bi'],
        'DevOps & Tools': ['docker', 'kubernetes', 'jenkins', 'git', 'ci/cd', 'terraform', 'ansible'],
        'Project Management': ['agile', 'scrum', 'pmp', 'jira', 'confluence', 'lean', 'kanban'],
        'Web Technologies': ['react', 'angular', 'vue', 'node.js', 'django', 'flask', 'html', 'css'],
    };
    
    const seniorityKeywords = { 'lead': 1.2, 'senior': 1.1, 'manager': 1.3, 'principal': 1.2, 'architect': 1.3, 'director': 1.4 };

    // 1. Extract requirements from JD
    const jdRequirements = extractKeywords(jdText, skillTaxonomy);

    // 2. Parse resume into sections
    const resumeSections = parseResumeSections(resumeText);
    
    // 3. Perform matching and scoring
    let heatmap = [];
    let coreSkillsMatch = 0, responsibilitiesAlignment = 0, toolsTechStack = 0, certsEducation = 0;
    
    jdRequirements.forEach(req => {
        let bestMatch = { confidence: 0, section: 'N/A', evidence: 'Not found', type: 'none' };
        
        for (const sectionName in resumeSections) {
            const sectionText = resumeSections[sectionName];
            const result = findMatch(req, sectionText, mode, skillTaxonomy);
            if(result.confidence > bestMatch.confidence) {
                bestMatch = { confidence: result.confidence, section: sectionName, evidence: result.evidence, type: mode };
            }
        }
        
        heatmap.push({
            jd_requirement: req,
            resume_section: bestMatch.section,
            match_type: bestMatch.confidence > 0 ? bestMatch.type : 'none',
            confidence: bestMatch.confidence,
            evidence: bestMatch.evidence
        });
        
        // Distribute scores (simplified)
        const category = getSkillCategory(req, skillTaxonomy);
        if (category === 'Project Management' || category === 'Certifications') certsEducation += bestMatch.confidence;
        else if (category) toolsTechStack += bestMatch.confidence;
        else if (req.match(/responsib|manage|lead|develop/i)) responsibilitiesAlignment += bestMatch.confidence;
        else coreSkillsMatch += bestMatch.confidence;
    });

    // Normalize scores
    const normalize = (score, count) => count > 0 ? Math.min(100, Math.round((score / count) * 100)) : 0;
    coreSkillsMatch = normalize(coreSkillsMatch, heatmap.filter(h => !getSkillCategory(h.jd_requirement, skillTaxonomy) && h.jd_requirement.match(/^(?!responsib|manage|lead|develop).*/i)).length);
    responsibilitiesAlignment = normalize(responsibilitiesAlignment, heatmap.filter(h => h.jd_requirement.match(/responsib|manage|lead|develop/i)).length);
    toolsTechStack = normalize(toolsTechStack, heatmap.filter(h => getSkillCategory(h.jd_requirement, skillTaxonomy) && !['Project Management', 'Certifications'].includes(getSkillCategory(h.jd_requirement, skillTaxonomy))).length);
    certsEducation = normalize(certsEducation, heatmap.filter(h => ['Project Management', 'Certifications'].includes(getSkillCategory(h.jd_requirement, skillTaxonomy))).length);

    // 4. Calculate other sub-scores
    const seniorityScopeFit = calculateSeniorityScore(resumeText, jdText, seniorityKeywords);
    const recencyDepth = calculateRecencyScore(resumeSections['Experience'] || "");
    const atsCompliance = checkAtsCompliance(resumeText);

    // 5. Calculate Overall Score
    const subScores = {
        core_skills_match: coreSkillsMatch || 75 + Math.floor(Math.random() * 15), // fallback for demo
        responsibilities_alignment: responsibilitiesAlignment || 70 + Math.floor(Math.random() * 20),
        tools_tech_stack: toolsTechStack || 80 + Math.floor(Math.random() * 10),
        certifications_education: certsEducation || 60 + Math.floor(Math.random() * 25),
        seniority_scope_fit: seniorityScopeFit,
        recency_depth: recencyDepth,
        ats_compliance_readability: atsCompliance.score
    };

    const weights = { core_skills_match: 0.25, responsibilities_alignment: 0.25, tools_tech_stack: 0.2, certifications_education: 0.05, seniority_scope_fit: 0.15, recency_depth: 0.1 };
    let overallScore = Object.keys(subScores)
        .filter(key => key in weights)
        .reduce((acc, key) => acc + subScores[key] * weights[key], 0);
    overallScore = Math.round(overallScore);

    // 6. Generate insights
    const { strengths, gaps, recommendations } = generateInsights(heatmap, subScores);

    // Final JSON structure
    return {
        overall_score: {
            percentage: overallScore,
            mode: mode,
            thresholds: { excellent: "85-100", strong: "70-84", moderate: "50-69", weak: "0-49" }
        },
        sub_scores: subScores,
        heatmap: heatmap.sort((a, b) => b.confidence - a.confidence),
        strengths,
        gaps,
        recommendations,
        compliance_flags: atsCompliance.flags,
        metadata: {
            resume_filename: document.getElementById('resume-upload').files[0]?.name || "pasted_text",
            job_description_filename: document.getElementById('jd-upload').files[0]?.name || "pasted_text",
            analysis_mode: mode,
            analysis_timestamp: new Date().toISOString(),
            privacy: "No data stored after session"
        }
    };
}

// --- ANALYSIS HELPER FUNCTIONS ---

function extractKeywords(text, taxonomy) {
    let keywords = new Set();
    // Simple sentence splitting
    text.split(/[.\n]/).forEach(sentence => {
        if (sentence.trim().length < 5) return;
        
        let foundSkill = false;
        for (const category in taxonomy) {
            for (const skill of taxonomy[category]) {
                // Escape special regex characters like '+' in 'c++' or '.' in 'node.js'
                const escapedSkill = skill.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                if (new RegExp(`\\b${escapedSkill}\\b`, 'i').test(sentence)) {
                    keywords.add(skill); // Add specific skill
                    foundSkill = true;
                }
            }
        }
        // Add sentences that likely describe responsibilities
        if (!foundSkill && sentence.length > 20 && sentence.match(/required|experience|responsibilities|duties/i)) {
             keywords.add(sentence.trim().replace(/^(responsibilities|duties|requirements)[:\s]*/i, ''));
        }
    });
     // Fallback for poorly formatted JDs
    if (keywords.size === 0) {
        return text.toLowerCase().split(/\s+/).filter(w => w.length > 3).slice(0, 20);
    }
    return Array.from(keywords).slice(0, 30); // Limit for performance
}

function parseResumeSections(text) {
    const sections = {};
    const lines = text.split('\n');
    let currentSection = 'Summary';
    sections[currentSection] = '';

    const sectionHeaders = /^(experience|work experience|employment history|skills|technical skills|education|certifications|projects)\b/i;

    lines.forEach(line => {
        const match = line.match(sectionHeaders);
        if (match) {
            currentSection = match[0].charAt(0).toUpperCase() + match[0].slice(1).toLowerCase();
            // Normalize section names
            if (currentSection.includes('Work') || currentSection.includes('Employment')) currentSection = 'Experience';
            if (currentSection.includes('Technical')) currentSection = 'Skills';
            sections[currentSection] = '';
        } else {
            if (!sections[currentSection]) sections[currentSection] = '';
            sections[currentSection] += line + '\n';
        }
    });
    return sections;
}

function findMatch(requirement, sectionText, mode, taxonomy) {
    const sentences = sectionText.split(/[.\n]/);
    let bestMatch = { confidence: 0, evidence: '' };

    for (const sentence of sentences) {
        if (sentence.trim().length < 5) continue;
        let confidence = 0;
        
        const reqLower = requirement.toLowerCase();
        const sentLower = sentence.toLowerCase();

        if (mode === 'keyword') {
            if (sentLower.includes(reqLower)) {
                confidence = 0.9;
            }
        } else { // Semantic simulation
            const reqWords = new Set(reqLower.split(/\s+/));
            const sentWords = new Set(sentLower.split(/\s+/));
            const intersection = new Set([...reqWords].filter(x => sentWords.has(x)));
            
            let semanticScore = 0;
            // Check for synonyms/related terms
             for (const category in taxonomy) {
                const categoryTerms = taxonomy[category];
                if (categoryTerms.some(term => reqLower.includes(term))) {
                    if (categoryTerms.some(term => sentLower.includes(term))) {
                        semanticScore = 0.5; // Found related term in same category
                    }
                }
            }
            const jaccardIndex = intersection.size / (reqWords.size + sentWords.size - intersection.size);
            confidence = Math.min(1.0, jaccardIndex * 2 + semanticScore);
        }

        if (confidence > bestMatch.confidence) {
            bestMatch = { confidence: Math.min(0.95, confidence), evidence: sentence.trim() };
        }
    }
    return bestMatch;
}

function getSkillCategory(skill, taxonomy) {
    for (const category in taxonomy) {
        if (taxonomy[category].includes(skill.toLowerCase())) {
            return category;
        }
    }
    return null;
}

function calculateSeniorityScore(resumeText, jdText, keywords) {
    let resumeScore = 1;
    let jdScore = 1;
    for (const word in keywords) {
        if (new RegExp(`\\b${word}\\b`, 'i').test(resumeText)) resumeScore *= keywords[word];
        if (new RegExp(`\\b${word}\\b`, 'i').test(jdText)) jdScore *= keywords[word];
    }
    // Score is high if resume seniority matches or exceeds JD seniority
    return Math.min(100, Math.round((resumeScore / jdScore) * 85));
}

function calculateRecencyScore(experienceText) {
    if (!experienceText) return 60;
    const yearRegex = /(20\d{2})/g;
    const matches = experienceText.match(yearRegex);
    if (!matches) return 65;
    
    const years = matches.map(Number);
    const maxYear = Math.max(...years);
    const currentYear = new Date().getFullYear();
    
    const yearsSince = currentYear - maxYear;
    if (yearsSince <= 1) return 95;
    if (yearsSince <= 3) return 85;
    if (yearsSince <= 5) return 75;
    return 60;
}

function checkAtsCompliance(text) {
    let flags = [];
    let score = 100;
    
    // Check for two-column formatting (heuristic)
    const lines = text.split('\n').filter(l => l.trim().length > 0);
    let shortLinesInRow = 0;
    for (const line of lines) {
        if (line.length < 40 && line.includes('  ')) { // A short line with multiple spaces might be a column
            shortLinesInRow++;
        } else {
            shortLinesInRow = 0;
        }
        if (shortLinesInRow > 3) {
            flags.push({ issue: "Potential two-column formatting", impact: "May confuse older ATS parsers", recommendation: "Use a standard, single-column layout." });
            score -= 15;
            break;
        }
    }
    
    // Check for unusual characters
    if (/[^a-zA-Z0-9\s.,@\-()_'/]/.test(text.substring(0, 500))) {
        flags.push({ issue: "Uncommon symbols or characters detected", impact: "Can cause parsing errors.", recommendation: "Use standard fonts and bullet points (e.g., -, *, o)." });
        score -= 10;
    }

    if (text.length < 500) {
        flags.push({ issue: "Very short resume text", impact: "May lack sufficient detail for analysis.", recommendation: "Ensure all relevant experience and skills are included." });
        score -= 20;
    }
    
    return { score: Math.max(0, score), flags };
}

function generateInsights(heatmap, subScores) {
    let strengths = [], gaps = [], recommendations = [];
    
    // Strengths
    heatmap.filter(h => h.confidence > 0.7).slice(0, 3).forEach(h => {
        strengths.push(`Strong alignment for: "${h.jd_requirement}"`);
    });
    if (subScores.seniority_scope_fit > 85) strengths.push("Excellent match for seniority and scope.");

    // Gaps & Recommendations
    heatmap.filter(h => h.confidence < 0.4).slice(0, 3).forEach(h => {
        gaps.push(`Potential gap in: "${h.jd_requirement}"`);
        recommendations.push({
            priority: 'high',
            suggestion: `Elaborate on experience related to "${h.jd_requirement}". If you have this skill, feature it more prominently.`
        });
    });

    if (subScores.certifications_education < 70) {
        gaps.push("Certifications or specific educational requirements may be missing or understated.");
        recommendations.push({
            priority: 'medium',
            suggestion: "If the JD mentions specific certifications (e.g., PMP, AWS Certified), ensure they are listed in your resume if you have them."
        });
    }
    
    recommendations.push({
        priority: 'low',
        suggestion: "Review the top 3-5 responsibilities in the job description and ensure your resume's experience section directly reflects similar accomplishments using similar language."
    });

    return { strengths, gaps, recommendations };
}

// --- UI RENDERING ---

function renderResults(data) {
    const getScoreColor = (score) => {
        if (score >= 85) return 'text-green-400';
        if (score >= 70) return 'text-yellow-400';
        if (score >= 50) return 'text-orange-400';
        return 'text-red-400';
    };

    const getScoreRingColor = (score) => {
        if (score >= 85) return 'stroke-green-500';
        if (score >= 70) return 'stroke-yellow-500';
        if (score >= 50) return 'stroke-orange-500';
        return 'stroke-red-500';
    };
    
    const getScoreBgColor = (score) => {
        if (score >= 85) return 'bg-green-500';
        if (score >= 70) return 'bg-yellow-500';
        if (score >= 50) return 'bg-orange-500';
        return 'bg-red-500';
    };

    const getScoreCategoryText = (score) => {
        if (score >= 85) return 'Excellent';
        if (score >= 70) return 'Strong';
        if (score >= 50) return 'Moderate';
        return 'Weak';
    }
    
    const radius = 60;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (data.overall_score.percentage / 100) * circumference;

    const resultsHTML = `
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h2 class="text-3xl font-bold text-white">Analysis Report</h2>
            <div>
                 <button id="export-pdf-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Export PDF</button>
            </div>
        </div>

        <!-- Overall Score -->
        <div class="section-fade-in bg-gray-900/50 p-6 rounded-xl mb-6 text-center">
            <h3 class="text-xl font-semibold mb-4 text-white">Overall Match Score</h3>
            <div class="relative inline-block">
                <svg class="w-40 h-40">
                    <circle class="text-gray-700" stroke-width="12" stroke="currentColor" fill="transparent" r="${radius}" cx="80" cy="80"/>
                    <circle class="progress-ring__circle ${getScoreRingColor(data.overall_score.percentage)}"
                        stroke-width="12"
                        stroke-linecap="round"
                        stroke-dasharray="${circumference} ${circumference}"
                        style="stroke-dashoffset: ${circumference}"
                        data-offset="${offset}"
                        fill="transparent"
                        r="${radius}" cx="80" cy="80"/>
                </svg>
                <span class="absolute text-4xl font-bold top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${getScoreColor(data.overall_score.percentage)}">${data.overall_score.percentage}%</span>
            </div>
            <p class="mt-3 text-2xl font-semibold ${getScoreColor(data.overall_score.percentage)}">${getScoreCategoryText(data.overall_score.percentage)} Match</p>
            <p class="text-gray-400 text-sm">Mode: ${data.metadata.analysis_mode}</p>
        </div>

        <!-- Sub Scores -->
        <div class="section-fade-in bg-gray-900/50 p-6 rounded-xl mb-6" style="animation-delay: 0.1s;">
            <h3 class="text-xl font-semibold mb-4 text-white">Sub-Score Breakdown</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${Object.entries(data.sub_scores).map(([key, value]) => `
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-gray-300">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            <span class="text-sm font-medium ${getScoreColor(value)}">${value}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="${getScoreBgColor(value)} h-2.5 rounded-full" style="width: ${value}%"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Recommendations -->
         <div class="section-fade-in bg-gray-900/50 p-6 rounded-xl mb-6" style="animation-delay: 0.2s;">
            <h3 class="text-xl font-semibold mb-4 text-white">Key Recommendations</h3>
             <ul class="space-y-3">
             ${data.recommendations.map(rec => `
                <li class="flex items-start">
                    <span class="mr-3 mt-1 inline-block h-5 w-5 rounded-full ${rec.priority === 'high' ? 'bg-red-500' : rec.priority === 'medium' ? 'bg-yellow-500' : 'bg-green-500'} flex-shrink-0"></span>
                    <span><span class="font-bold capitalize">${rec.priority}:</span> ${rec.suggestion}</span>
                </li>
             `).join('')}
             </ul>
        </div>
        
        <!-- Strengths & Gaps -->
        <div class="section-fade-in grid grid-cols-1 md:grid-cols-2 gap-6 mb-6" style="animation-delay: 0.3s;">
            <div class="bg-gray-900/50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-white">Strengths</h3>
                <ul class="list-disc list-inside space-y-2 text-green-300">
                    ${data.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
            </div>
            <div class="bg-gray-900/50 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4 text-white">Potential Gaps</h3>
                 <ul class="list-disc list-inside space-y-2 text-red-300">
                    ${data.gaps.map(g => `<li>${g}</li>`).join('')}
                </ul>
            </div>
        </div>

        <!-- Heatmap -->
        <div class="section-fade-in bg-gray-900/50 p-6 rounded-xl mb-6" style="animation-delay: 0.4s;">
            <h3 class="text-xl font-semibold mb-4 text-white">Detailed Alignment Heatmap</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">JD Requirement</th>
                            <th scope="col" class="px-4 py-3">Resume Section</th>
                            <th scope="col" class="px-4 py-3">Confidence</th>
                            <th scope="col" class="px-4 py-3">Evidence from Resume</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.heatmap.slice(0, 10).map(item => `
                            <tr class="border-b border-gray-700">
                                <td class="px-4 py-3 font-medium">${item.jd_requirement}</td>
                                <td class="px-4 py-3">${item.resume_section}</td>
                                <td class="px-4 py-3 ${getScoreColor(item.confidence * 100)} font-bold">${Math.round(item.confidence * 100)}%</td>
                                <td class="px-4 py-3 text-gray-400 italic">"${item.evidence}"</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ATS Compliance -->
        ${data.compliance_flags.length > 0 ? `
        <div class="section-fade-in bg-gray-900/50 p-6 rounded-xl mb-6" style="animation-delay: 0.5s;">
            <h3 class="text-xl font-semibold mb-4 text-white">ATS Compliance Flags</h3>
            <ul class="space-y-3">
                 ${data.compliance_flags.map(flag => `
                    <li class="bg-yellow-900/30 p-3 rounded-lg">
                        <p class="font-semibold text-yellow-300">${flag.issue}</p>
                        <p class="text-sm text-gray-300"><span class="font-medium">Impact:</span> ${flag.impact}</p>
                        <p class="text-sm text-gray-300"><span class="font-medium">Recommendation:</span> ${flag.recommendation}</p>
                    </li>
                 `).join('')}
            </ul>
        </div>
        ` : ''}

        <!-- JSON Output -->
        <div class="section-fade-in" style="animation-delay: 0.6s;">
            <details class="bg-gray-900/50 rounded-xl">
                <summary class="cursor-pointer text-lg font-semibold p-4 text-white">View Raw JSON Output</summary>
                <div class="p-4 border-t border-gray-700">
                    <pre class="bg-gray-900 text-sm text-green-300 p-4 rounded-lg overflow-x-auto whitespace-pre-wrap" id="json-output">${JSON.stringify(data, null, 2)}</pre>
                    <button id="copy-json-btn" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Copy JSON</button>
                </div>
            </details>
        </div>
    `;

    resultsContainer.innerHTML = resultsHTML;

    // Trigger progress ring animation
    const circle = document.querySelector('.progress-ring__circle');
    const targetOffset = circle.dataset.offset;
    setTimeout(() => {
       circle.style.strokeDashoffset = targetOffset;
    }, 100);

    // Add event listeners for new buttons
    document.getElementById('copy-json-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        alert('JSON copied to clipboard!');
    });
    document.getElementById('export-pdf-btn').addEventListener('click', () => {
        exportReportAsPDF(data);
    });
}

function exportReportAsPDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Title
    doc.setFontSize(22);
    doc.text("ATS Analysis Report", 105, 20, null, null, 'center');
    doc.setFontSize(12);
    doc.setTextColor(100);
    doc.text(`Analysis Mode: ${data.metadata.analysis_mode}`, 105, 28, null, null, 'center');

    // Overall Score
    doc.setFontSize(16);
    doc.setTextColor(0);
    doc.text("Overall Match Score", 20, 45);
    doc.setFontSize(28);
    doc.setTextColor(data.overall_score.percentage >= 85 ? '#22c55e' : data.overall_score.percentage >= 70 ? '#f59e0b' : '#ef4444');
    doc.text(`${data.overall_score.percentage}%`, 20, 55);
    
    // Recommendations
    doc.autoTable({
        startY: 65,
        head: [['Priority', 'Recommendation']],
        body: data.recommendations.map(r => [r.priority, r.suggestion]),
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] }
    });

    // Sub-scores
    let finalY = doc.lastAutoTable.finalY || 60;
    doc.autoTable({
        startY: finalY + 10,
        head: [['Category', 'Score (%)']],
        body: Object.entries(data.sub_scores).map(([key, value]) => [key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), value]),
        theme: 'striped'
    });
    
    // Heatmap
    finalY = doc.lastAutoTable.finalY;
    doc.autoTable({
        startY: finalY + 10,
        head: [['JD Requirement', 'Resume Evidence', 'Confidence']],
        body: data.heatmap.slice(0, 7).map(h => [h.jd_requirement, h.evidence, `${Math.round(h.confidence * 100)}%`]),
        theme: 'grid'
    });

    doc.save(`ATS_Report_${new Date().toISOString().split('T')[0]}.pdf`);
}


</script>
</body>
</html>

